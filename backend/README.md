# Backend Scripts

Python scripts for managing territory data. **No database required** - all data stored as JSON files.

## Setup

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## Scripts

### `setup.py` - Initialize Data

Generates initial `teams.json` and `ownership.json` files:

```bash
python setup.py
```

**What it does:**
1. Creates `public/data/teams.json` with 20 teams
2. Calculates centroid for each of 3,221 counties
3. Assigns each county to nearest team
4. Saves to `public/data/ownership.json`

**Run this once** to set up the map.

### `ingest_games.py` - Fetch Game Results

Download completed FBS games from the CollegeFootballData API and normalize them for later processing:

```bash
python ingest_games.py --season 2025 --season-type both
```

The script stores weekly summaries under `frontend/public/data/games/<season>/week-XX.json` and creates an index file describing the timeline. Set the `CFBD_API_KEY` environment variable (or use `.env`) for higher rate limits.

### `apply_transfers.py` - Apply Territory Seizures

Walk the normalized game results in chronological order and update county ownership:

```bash
python apply_transfers.py --season 2025
```

Outputs per-week ownership snapshots to `frontend/public/data/ownership/<season>/week-XX.json`, records transfer history, and refreshes the frontend ownership index. Use `--dry-run` to preview changes without writing files.

## Library Modules

### `lib/territory.py`
- `calculate_centroid()` - Get center point of county polygon
- `calculate_distance()` - Haversine distance between coordinates
- `assign_initial_ownership()` - Assign counties to nearest teams *(legacy helper)*

### `lib/game_engine.py`
- `process_game_result()` - Determine territory transfers
- `validate_ownership()` - Check data consistency

### `lib/db.py`
- `load_json()` / `save_json()` - File I/O helpers
- `load_teams()` / `save_teams()` - Team data
- `load_ownership()` / `save_ownership()` - Territory state
- `append_transfer()` - Log transfer history

## Data Files

All files in `public/data/`:

```
public/data/
├── us-counties.geojson          # Source data (3.1MB, committed)
├── teams.json                   # Generated by setup.py
├── ownership.json               # Baseline ownership (week 0)
├── ownership/
│   └── 2025/
│       ├── index.json           # Available weeks for the dropdown
│       └── week-01.json         # Snapshot after Week 1
├── games/
│   └── 2025/
│       ├── index.json           # Season timeline
│       └── week-01.json         # Normalized game results
└── transfers.json               # Transfer history log
```

## Workflow

1. **Setup**: `python setup.py` (once)
2. **Ingest**: `python ingest_games.py --season 2025`
3. **Apply**: `python apply_transfers.py --season 2025`
4. **Deploy**: `git add public/data && git commit && git push`
5. **Live**: Vercel auto-deploys updated map

## Environment Variables

Create `.env` file:

```
CFBD_API_KEY=your_api_key_here
```

Get API key from https://collegefootballdata.com
